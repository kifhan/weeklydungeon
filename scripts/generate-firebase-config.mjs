import fs from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const repoRoot = path.resolve(__dirname, '..');
const mode = process.env.NODE_ENV === 'production' ? 'production' : 'development';

function parseDotEnv(src) {
  const out = {};
  const lines = src.split(/\r?\n/);
  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith('#')) continue;
    const eq = trimmed.indexOf('=');
    if (eq === -1) continue;
    const key = trimmed.slice(0, eq).trim();
    let value = trimmed.slice(eq + 1).trim();

    // Strip surrounding quotes
    if (
      (value.startsWith('"') && value.endsWith('"')) ||
      (value.startsWith("'") && value.endsWith("'"))
    ) {
      value = value.slice(1, -1);
    }

    out[key] = value;
  }
  return out;
}

async function readEnvFile(filePath) {
  try {
    const contents = await fs.readFile(filePath, 'utf8');
    return parseDotEnv(contents);
  } catch {
    return {};
  }
}

// Minimal Vite-like precedence (lowest -> highest):
// .env, .env.local, .env.<mode>, .env.<mode>.local, then process.env overrides all
const env = {
  ...(await readEnvFile(path.join(repoRoot, '.env'))),
  ...(await readEnvFile(path.join(repoRoot, '.env.local'))),
  ...(await readEnvFile(path.join(repoRoot, `.env.${mode}`))),
  ...(await readEnvFile(path.join(repoRoot, `.env.${mode}.local`))),
  ...process.env,
};

const requiredKeys = [
  'VITE_FIREBASE_API_KEY',
  'VITE_FIREBASE_AUTH_DOMAIN',
  'VITE_FIREBASE_PROJECT_ID',
  'VITE_FIREBASE_STORAGE_BUCKET',
  'VITE_FIREBASE_MESSAGING_SENDER_ID',
  'VITE_FIREBASE_APP_ID',
];

const missing = requiredKeys.filter((k) => !env[k]);
if (missing.length) {
  // Keep message actionable for local dev
  throw new Error(
    `Missing required Firebase env vars: ${missing.join(
      ', '
    )}. Add them to .env (or .env.${mode}).`
  );
}

const firebaseConfig = {
  apiKey: env.VITE_FIREBASE_API_KEY,
  authDomain: env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: env.VITE_FIREBASE_APP_ID,
};

const outPath = path.join(repoRoot, 'public', 'firebase-config.js');
const contents =
  `// AUTO-GENERATED FILE. DO NOT EDIT.\n` +
  `// Generated by scripts/generate-firebase-config.mjs from .env\n` +
  `self.__FIREBASE_CONFIG__ = ${JSON.stringify(firebaseConfig, null, 2)};\n`;

await fs.writeFile(outPath, contents, 'utf8');
console.log(`Wrote ${path.relative(repoRoot, outPath)}`);

