rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthed(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    function isStringField(name, maxLen) {
      return name in request.resource.data && request.resource.data[name] is string && request.resource.data[name].size() <= maxLen;
    }

    // Per-user document tree
    match /users/{uid} {
      allow read: if isAuthed(uid);
      allow write: if isAuthed(uid);

      // Boards (Kanban)
      match /boards/{boardId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
        match /columns/{columnId} {
          allow read, write: if request.auth != null && request.auth.uid == uid;
        }
        match /cards/{cardId} {
          allow read, write: if request.auth != null && request.auth.uid == uid;
        }
      }

      // Habits
      match /habits/{habitId} {
        allow read: if isAuthed(uid);
        allow create, update: if isAuthed(uid) &&
          isStringField('id', 200) &&
          isStringField('date', 20) &&
          isStringField('time', 20) &&
          isStringField('state', 40) &&
          isStringField('statusMemo', 2000) &&
          isStringField('trigger', 2000) &&
          isStringField('action', 2000);
        allow delete: if isAuthed(uid);
      }

      // Weeks
      match /weeks/{weekKey} {
        allow read: if isAuthed(uid);
        allow create, update: if isAuthed(uid) && isStringField('weekKey', 20) && isStringField('weekStartDate', 20) && ('data' in request.resource.data);
        allow delete: if isAuthed(uid);
      }

      // Logs
      match /logs/{logId} {
        allow read: if isAuthed(uid);
        allow create, update: if isAuthed(uid) &&
          isStringField('id', 200) &&
          isStringField('blockId', 200) &&
          isStringField('blockName', 500) &&
          isStringField('day', 20) &&
          ('energyLevel' in request.resource.data && request.resource.data.energyLevel is number) &&
          isStringField('blockType', 40);
        allow delete: if isAuthed(uid);
      }

      // Life Question Bot
      match /questions/{questionId} {
        allow read, write: if isAuthed(uid);
      }
      match /metaQuestions/{metaQuestionId} {
        allow read, write: if isAuthed(uid);
      }
      match /questionReservations/{reservationId} {
        allow read, write: if isAuthed(uid);
      }
      match /answers/{answerId} {
        allow read, write: if isAuthed(uid);
      }
      match /questionContexts/{contextId} {
        allow read: if isAuthed(uid);
        // Clients cannot write embeddings (server-only)
        allow create, update: if isAuthed(uid) && !('embedding' in request.resource.data);
      }
      match /deliveries/{deliveryId} {
        allow read: if isAuthed(uid);
        // Clients can update status to ACKED only
        allow update: if isAuthed(uid) && 
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']) &&
          request.resource.data.status == 'ACKED';
        // Clients cannot create deliveries (server-only)
      }
      match /notificationTokens/{token} {
        allow read, write: if isAuthed(uid);
      }

      // Settings (Character Profile)
      match /settings/{settingId} {
        allow read: if isAuthed(uid);
        allow create, update: if isAuthed(uid);
        allow delete: if isAuthed(uid);
      }
    }

    // Deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}